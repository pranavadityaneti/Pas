generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  MERCHANT
  CONSUMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

// --- Geographic Models ---

model City {
  id        String   @id @default(uuid())
  name      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]
  serviceAreas ServiceArea[]
}

model ServiceArea {
  id        String   @id @default(uuid())
  cityId    String
  city      City     @relation(fields: [cityId], references: [id])
  pincode   String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

// --- User & Store Models ---

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          Role     @default(CONSUMER)
  name          String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  orders          Order[]  @relation("CustomerOrders")
  handledOrders   Order[]  @relation("StaffHandledOrders")
  managedStore    Store?   @relation("StoreManager")
}

model Store {
  id          String   @id @default(uuid())
  name        String
  cityId      String
  city        City     @relation(fields: [cityId], references: [id])
  address     String?
  image       String?
  managerId   String?  @unique
  manager     User?    @relation("StoreManager", fields: [managerId], references: [id])
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    StoreProduct[]
  orders      Order[]
}

// --- Catalog Models ---

// Global Master Catalog
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  image       String?
  mrp         Float
  category    String
  brand       String?

  ean         String?
  createdByStoreId String? // Null = Global, Value = Private to Store
  
  // Specs for Commerce
  unitType    String?   // "ml", "L", "kg", "g", "pc"
  unitValue   Float?    // 500
  hsnCode     String?   // "0401"
  gstRate     Float?    // 5.0
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  storeProducts StoreProduct[]
  auditLogs     ProductAuditLog[]
  images        ProductImage[]
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  name      String?  // e.g. "Front View", "Back View"
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProductAuditLog {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  action    String   // "UPDATE", "CREATE", "DELETE"
  field     String?  // "mrp", "name", etc.
  oldValue  String?
  newValue  String?
  changedAt DateTime @default(now())
  changedBy String?  // User ID or Email
}

// Store Specific Inventory (Price & Stock)
model StoreProduct {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  price       Float    // Selling Price
  stock       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, productId])
  orderItems OrderItem[]
}

// --- Transaction Models ---

model Order {
  id              String      @id @default(uuid())
  orderNumber     String      @unique @map("order_number") // PAS-YYYYMMDD-XXXX
  userId          String      @map("user_id")
  user            User        @relation("CustomerOrders", fields: [userId], references: [id])
  storeId         String      @map("store_id")
  store           Store       @relation(fields: [storeId], references: [id])
  staffId         String?     @map("staff_id")
  staff           User?       @relation("StaffHandledOrders", fields: [staffId], references: [id])
  
  status          OrderStatus @default(PENDING)
  totalAmount     Float       @map("total_amount")
  isPaid          Boolean     @default(false) @map("ispaid")
  otp             String?     // 4-digit PIN for pickup verification
  cancelledReason String?     @map("cancelled_reason")
  
  metadata        Json?       @map("metadata") // For platform fees, taxes, loyalty pts
  
  items           OrderItem[]
  
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  @@index([orderNumber])
  @@index([storeId])
  @@index([userId])
}

model OrderItem {
  id             String       @id @default(uuid())
  orderId        String       @map("order_id")
  order          Order        @relation(fields: [orderId], references: [id])
  storeProductId String       @map("store_product_id")
  storeProduct   StoreProduct @relation(fields: [storeProductId], references: [id])
  
  quantity       Int
  price          Float       @map("price")
}

// --- Legacy & Merchant Management ---

model Merchant {
  id                  String   @id @default(uuid())
  storeName           String   @map("store_name")
  branchName          String?  @map("branch_name")
  ownerName           String   @map("owner_name")
  email               String
  phone               String
  city                String?
  address             String?
  latitude            Float?
  longitude           Float?
  hasBranches         Boolean? @map("has_branches")
  kycStatus           String?  @map("kyc_status")
  status              String?
  rating              Float?
  commissionRate      Float?   @map("commission_rate")
  operatingHours      String?  @map("operating_hours")
  operatingDays       String[] @map("operating_days")
  
  // Compliance & KYC
  panNumber           String?  @map("pan_number")
  aadharNumber        String?  @map("aadhar_number")
  bankAccountNumber   String?  @map("bank_account_number")
  ifscCode            String?  @map("ifsc_code")
  
  panDocUrl           String?  @map("pan_doc_url")
  panDocumentUrl      String?  @map("pan_document_url")
  aadharFrontUrl      String?  @map("aadhar_front_url")
  aadharBackUrl       String?  @map("aadhar_back_url")
  gstNumber           String?  @map("gst_number")
  gstCertificateUrl   String?  @map("gst_certificate_url")
  msmeNumber          String?  @map("msme_number")
  msmeCertificateUrl  String?  @map("msme_certificate_url")
  storePhotos         String[] @map("store_photos")
  
  category            String?
  kycRejectionReason  String?  @map("kyc_rejection_reason")
  turnoverRange       String?  @map("turnover_range")
  
  createdAt           DateTime? @default(now()) @map("created_at")
  updatedAt           DateTime? @updatedAt @map("updated_at")

  branches            MerchantBranch[]

  @@map("merchants")
}

model MerchantBranch {
  id          String   @id @default(uuid())
  merchantId  String?  @map("merchant_id")
  merchant    Merchant? @relation(fields: [merchantId], references: [id])
  branchName  String   @map("branch_name")
  managerName String?  @map("manager_name")
  phone       String?
  email       String?
  address     String?
  city        String?
  latitude    Float?
  longitude   Float?
  isActive    Boolean? @map("is_active")
  createdAt   DateTime? @default(now()) @map("created_at")
  updatedAt   DateTime? @updatedAt @map("updated_at")

  @@map("merchant_branches")
}
