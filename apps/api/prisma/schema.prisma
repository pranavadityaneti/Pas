generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  SUPER_ADMIN
  MERCHANT
  CONSUMER
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  COMPLETED
  CANCELLED
}

// --- Geographic Models ---

model City {
  id        String   @id @default(uuid())
  name      String   @unique
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  stores    Store[]
  serviceAreas ServiceArea[]
}

model ServiceArea {
  id        String   @id @default(uuid())
  cityId    String
  city      City     @relation(fields: [cityId], references: [id])
  pincode   String
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
}

// --- User & Store Models ---

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  role          Role     @default(CONSUMER)
  name          String?
  phone         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  // Relations
  orders        Order[]
  managedStore  Store?   @relation("StoreManager")
}

model Store {
  id          String   @id @default(uuid())
  name        String
  cityId      String
  city        City     @relation(fields: [cityId], references: [id])
  address     String?
  image       String?
  managerId   String?  @unique
  manager     User?    @relation("StoreManager", fields: [managerId], references: [id])
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products    StoreProduct[]
  orders      Order[]
}

// --- Catalog Models ---

// Global Master Catalog
model Product {
  id          String   @id @default(uuid())
  name        String
  description String?
  image       String?
  mrp         Float
  category    String
  brand       String?
  ean         String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  storeProducts StoreProduct[]
  auditLogs     ProductAuditLog[]
  images        ProductImage[]
}

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  name      String?  // e.g. "Front View", "Back View"
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())
}

model ProductAuditLog {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  action    String   // "UPDATE", "CREATE", "DELETE"
  field     String?  // "mrp", "name", etc.
  oldValue  String?
  newValue  String?
  changedAt DateTime @default(now())
  changedBy String?  // User ID or Email
}

// Store Specific Inventory (Price & Stock)
model StoreProduct {
  id          String   @id @default(uuid())
  storeId     String
  store       Store    @relation(fields: [storeId], references: [id])
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  
  price       Float    // Selling Price
  stock       Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([storeId, productId])
  orderItems OrderItem[]
}

// --- Transaction Models ---

model Order {
  id          String      @id @default(uuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])
  storeId     String
  store       Store       @relation(fields: [storeId], references: [id])
  
  status      OrderStatus @default(PENDING)
  totalAmount Float
  
  items       OrderItem[]
  
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
}

model OrderItem {
  id             String       @id @default(uuid())
  orderId        String
  order          Order        @relation(fields: [orderId], references: [id])
  storeProductId String
  storeProduct   StoreProduct @relation(fields: [storeProductId], references: [id])
  
  quantity       Int
  price          Float       // Price at time of purchase
}
